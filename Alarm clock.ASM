;------------------IO定义------------------------------
KEY1 EQU P3.3
KEY2 EQU P3.4
KEY3 EQU P3.5
LED_DATA EQU P1
LED_SEG EQU P2
BEEP EQU P3.7
;------------------闹钟变量---------------------------
MODE EQU 7CH
AHOUSE EQU 79H
AMINITUE EQU 78H
ASECOND EQU 73H
AFLAG EQU 7DH
;-------------------时间变量--------------------------
COUNT EQU 7FH
CCOUNT EQU 7EH
HOUSE EQU 76H
MINITUE EQU 75H
SECOND EQU 74H
CHOUSE EQU 72H
CMINITUE EQU 71H
CSECOND EQU 70H
;---------------中断源入口地址定义----------------
ORG 0000H
LJMP BOOT
; ORG 0003H ;定义外部中断0服务程序入口
;LJMP INT_IE0
; ORG 00013H ;定义外部中断1服务程序入口
;LJMP INT_IE1
ORG 000BH ;定义计数器0服务程序入口
LJMP INT_T0
ORG 001BH ;定义计数器1服务程序入口
LJMP INT_T1
;ORG 0023H ;定义串行通服务程序入口
;LJMP INT_RS
;---------------复位函数------------------------
BOOT: MOV SP,#30H
MOV COUNT,#0
MOV CCOUNT,#0
MOV SECOND,#00
MOV MINITUE,#30
MOV HOUSE,#12
MOV CSECOND,#0
MOV CMINITUE,#0
MOV CHOUSE,#0
MOV AMINITUE,#31
MOV AHOUSE,#12
MOV MODE,#00
MOV AFLAG,#0
LCALL TO_INIT
LCALL T1_INIT
SETB EA
LJMP MAIN
;---------------主函数---------------------------
MAIN:
LCALL KEY_SCAN
MOV A,MODE
CJNE A,#0,L1
MOV A,AFLAG
CJNE A,#0,SA_DISPLAY
LCALL DISPLAY
L1: CJNE A,#1,L2
LCALL H_DISPLAY
L2: CJNE A,#2,L3
LCALL M_DISPLAY
L3: CJNE A,#3,L4
LCALL AH_DISPLAY
L4: CJNE A,#4,L5
LCALL AM_DISPLAY
L5: CJNE A,#5,MAIN
LCALL C_DISPLAY
LJMP MAIN
SA_DISPLAY: LCALL A_DISPLAY
JMP MAIN
;-----------------计数器0初始化程序-------------------
TO_INIT:
MOV TMOD,#01H
SETB ET0
MOV TL0,#0FCH ;f0=11.0592MHZ
;65536-46083=8BFCH ，50毫秒定时中断
MOV TH0,#8BH
SETB TR0
RET
;-----------------计数器1初始化程序-------------------
T1_INIT:
MOV TMOD,#10H
SETB ET1
MOV TL1,#0FFH ;f0=11.0592MHZ
;65536-56319==DBFFH ，10毫秒定时中断
MOV TH1,#0DBH
RET
;---------------计数器0中断服务程序------------------------
INT_T0: PUSH ACC
PUSH PSW
MOV TL0,#0FCH ;恢复时间常数
MOV TH0,#8BH
INC COUNT
MOV A,COUNT
CJNE A,#20,CLEAR
INC SECOND
MOV A,SECOND
CJNE A,#60,CLEAR
mov SECOND,#00
INC MINITUE
MOV A,AFLAG
CJNE A,#1,STEP_ALARM
LCALL ALARM
STEP_ALARM: MOV A,MINITUE
CJNE A,#60,CLEAR
MOV MINITUE,#00
INC HOUSE
MOV A,HOUSE
CJNE A,#24,CLEAR
MOV HOUSE,#00
CLEAR: POP PSW
POP ACC
RETI
;---------------计数器0中断服务程序------------------------
INT_T1: PUSH ACC
PUSH PSW
MOV TL1,#0FFH ;恢复时间常数
MOV TH1,#0DBH
INC CSECOND
MOV A,CSECOND
CJNE A,#100,CLEAR
mov CSECOND,#00
INC CMINITUE
MOV A,CMINITUE
CJNE A,#60,CLEAR
MOV CMINITUE,#00
INC CHOUSE
MOV A,CHOUSE
CJNE A,#24,CLEAR
MOV CHOUSE,#00
;-------------------键盘函数------------------
KEY_SCAN:
JNB KEY1,SET_KEY
JNB KEY3,DOWN_KEY
JNB KEY2,UP_KEY
RET
;------------------设置键---------------------
SET_KEY: LCALL KEYDELAY
JNB KEY1,CH_MODE
RET
CH_MODE: INC MODE
CLR BEEP
LCALL KEYDELAY
SETB BEEP
MOV A,MODE
CJNE A,#3,HF
SETB TR0
HF: CJNE A,#6,EIXT
MOV MODE,#0
SETB TR0
RET
EIXT:RET
;------------------------减少设置------------------
DOWN_KEY: LCALL KEYDELAY
JNB KEY3,DOWN
DOWN: MOV A,MODE
CJNE A,#0,DQ0
LJMP STOP_ALARM
DQ0: CJNE A,#1,DQ1
LJMP DOWN_HOUSE
DQ1: CJNE A,#2,DQ2
LJMP DOWN_MINITUE
DQ2: CJNE A,#3,DQ3
LJMP ADOWN_HOUSE
DQ3: CJNE A,#4,DQ4
LJMP ADOWN_MINITUE
DQ4: CJNE A,#5,EIXT
LJMP T1_STOP
T1_STOP: CLR TR1
RET
STOP_ALARM: MOV AFLAG,#0
SETB BEEP
RET
;-------------------加值键---------------------
UP_KEY: LCALL KEYDELAY
JNB KEY2,UP
UP: MOV A,MODE
CJNE A,#0,Q0
LJMP START_ALARM
Q0: CJNE A,#1,Q1
LJMP UP_HOUSE
Q1: CJNE A,#2,Q2
LJMP UP_MINITUE
Q2: CJNE A,#3,Q3
LJMP AUP_HOUSE
Q3: CJNE A,#4,Q4
LJMP AUP_MINITUE
Q4: CJNE A,#5,EIXT
LJMP T1_START
T1_START: SETB TR1
RET
START_ALARM: MOV AFLAG,#1
CLR BEEP
LCALL KEYDELAY
SETB BEEP
RET
;-------------减------------------------
;---------------分钟设置----------------
DOWN_MINITUE: CLR TR0
DEC MINITUE
MOV A,MINITUE
CJNE A,#0,DOWN1_MINITUE
MOV MINITUE,#59
DOWN1_MINITUE:LCALL KEYDELAY
JNB KEY3,DOWN1_MINITUE
RET
;---------------小时设置----------------------
DOWN_HOUSE: CLR TR0
DEC HOUSE
MOV A,HOUSE
CJNE A,#0,UP1_HOUSE
MOV HOUSE,#23
DOWN1_HOUSE:LCALL KEYDELAY
JNB KEY3,DOWN1_HOUSE
RET
;---------------闹铃分钟设置----------------------
ADOWN_MINITUE:
DEC AMINITUE
MOV A,AMINITUE
CJNE A,#0,AUP1_MINITUE
MOV AMINITUE,#59
ADOWN1_MINITUE:LCALL KEYDELAY
JNB KEY3,ADOWN1_MINITUE
RET
;---------------闹铃小时设置----------------------
ADOWN_HOUSE:
DEC AHOUSE
MOV A,AHOUSE
CJNE A,#0,AUP1_HOUSE
MOV AHOUSE,#23
ADOWN1_HOUSE:LCALL KEYDELAY
JNB KEY3,ADOWN1_HOUSE
RET
;***********************加************************
;---------------分钟设置----------------------
UP_MINITUE: CLR TR0
INC MINITUE
MOV A,MINITUE
CJNE A,#60,UP1_MINITUE
MOV MINITUE,#0
UP1_MINITUE:LCALL KEYDELAY
JNB KEY2,UP1_MINITUE
RET
;---------------小时设置----------------------
UP_HOUSE: CLR TR0
INC HOUSE
MOV A,HOUSE
CJNE A,#24,UP1_HOUSE
MOV HOUSE,#0
UP1_HOUSE:LCALL KEYDELAY
JNB KEY2,UP1_HOUSE
RET
;---------------闹铃分钟设置----------------------
AUP_MINITUE:
INC AMINITUE
MOV A,AMINITUE
CJNE A,#60,AUP1_MINITUE
MOV AMINITUE,#0
AUP1_MINITUE:LCALL KEYDELAY
JNB KEY2,AUP1_MINITUE
RET
;---------------闹铃小时设置----------------------
AUP_HOUSE:
INC AHOUSE
MOV A,AHOUSE
CJNE A,#24,AUP1_HOUSE

MOV AHOUSE,#0
AUP1_HOUSE:LCALL KEYDELAY
JNB KEY2,AUP1_HOUSE
RET
KEYDELAY: MOV R3,#230 ;1MS延时程序
DEL1: MOV R4,#250
DEL2: DJNZ R4,DEL2
DJNZ R3,DEL1
RET
;-----------------闹钟函数-------------------
ALARM: MOV A,HOUSE
CJNE A,AHOUSE,EIXT_ALARM
MOV A,MINITUE
CJNE A,AMINITUE,EIXT_ALARM
CLR BEEP
RET
EIXT_ALARM: SETB BEEP
RET
;----------------显示函数---------------------
;----------------带闹铃正常走时显示-----------
A_DISPLAY:
MOV A,SECOND
MOV B,#10
MOV LED_SEG,#0FBH
DIV AB
MOV DPTR,#TABLE
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_SEG,#0F7H
MOV A,B
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_DATA,#0BFH
MOV LED_SEG,#0FDH
LCALL DL500MS
MOV A,MINITUE
MOV B,#10
MOV LED_SEG,#0EFH
DIV AB
MOV DPTR,#TABLE
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_SEG,#0FEH
MOV A,B
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_DATA,#0B7H
MOV LED_SEG,#0DFH
LCALL DL500MS
MOV A,HOUSE
MOV B,#10
MOV LED_SEG,#07FH
DIV AB
MOV DPTR,#TABLE
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_SEG,#0BFH
MOV A,B
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
RET
;---------------无设置闹铃正常走时显示----------------
DISPLAY:
MOV A,SECOND
MOV B,#10
MOV LED_SEG,#0FBH
DIV AB
MOV DPTR,#TABLE
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_SEG,#0F7H
MOV A,B
MOVC A,@A+DPTR

MOV LED_DATA,A
LCALL DL500MS
MOV LED_DATA,#0BFH
MOV LED_SEG,#0FDH
LCALL DL500MS
MOV A,MINITUE
MOV B,#10
MOV LED_SEG,#0EFH
DIV AB
MOV DPTR,#TABLE
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_SEG,#0FEH
MOV A,B
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_DATA,#0BFH
MOV LED_SEG,#0DFH
LCALL DL500MS
MOV A,HOUSE
MOV B,#10
MOV LED_SEG,#07FH
DIV AB
MOV DPTR,#TABLE
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_SEG,#0BFH
MOV A,B
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
RET
;---------------------秒表显示--------------
C_DISPLAY:
MOV A,CSECOND

MOV B,#10
MOV LED_SEG,#0FBH
DIV AB
MOV DPTR,#TABLE
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_SEG,#0F7H
MOV A,B
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_DATA,#0BFH
MOV LED_SEG,#0FDH
LCALL DL500MS
MOV A,CMINITUE
MOV B,#10
MOV LED_SEG,#0EFH
DIV AB
MOV DPTR,#TABLE
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_SEG,#0FEH
MOV A,B
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_DATA,#0BFH
MOV LED_SEG,#0DFH
LCALL DL500MS
MOV A,CHOUSE
MOV B,#10
MOV LED_SEG,#07FH
DIV AB
MOV DPTR,#TABLE
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_SEG,#0BFH

MOV A,B
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
RET
;---------------设置小时显示函数-------------
H_DISPLAY:
MOV A,HOUSE
MOV B,#10
MOV LED_SEG,#07FH
DIV AB
MOV DPTR,#TABLE
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_SEG,#0BFH
MOV A,B
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_SEG,#0FBH
MOV LED_DATA,#0C6H
LCALL DL500MS
MOV LED_SEG,#0F7H
MOV LED_DATA,#0C7H
LCALL DL500MS
RET
;-------------设置分钟显示函数-------------
M_DISPLAY:
MOV A,MINITUE
MOV B,#10
MOV LED_SEG,#0EFH
DIV AB
MOV DPTR,#TABLE
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_SEG,#0FEH
MOV A,B
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS

MOV LED_SEG,#0FBH
MOV LED_DATA,#0C6H
LCALL DL500MS
MOV LED_SEG,#0F7H
MOV LED_DATA,#0C7H
LCALL DL500MS
RET
;----------------设置闹铃小时显示函数-------------
AH_DISPLAY:
MOV A,AHOUSE
MOV B,#10
MOV LED_SEG,#07FH
DIV AB
MOV DPTR,#TABLE
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_SEG,#0BFH
MOV A,B
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_SEG,#0FBH
MOV LED_DATA,#88H
LCALL DL500MS
MOV LED_SEG,#0F7H
MOV LED_DATA,#0C7H
LCALL DL500MS
RET
;----------------设置闹铃分钟显示函数--------------
AM_DISPLAY:
MOV A,AMINITUE
MOV B,#10
MOV LED_SEG,#0EFH
DIV AB
MOV DPTR,#TABLE
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_SEG,#0FEH

MOV A,B
MOVC A,@A+DPTR
MOV LED_DATA,A
LCALL DL500MS
MOV LED_SEG,#0FBH
MOV LED_DATA,#88H
LCALL DL500MS
MOV LED_SEG,#0F7H
MOV LED_DATA,#0C7H
LCALL DL500MS
RET
;------------------------延时程序 --------------------------
DL1MS: MOV R6,#10H ;1MS延时程序
DL1: MOV R7,#11H
DL2: DJNZ R7,DL2
DJNZ R6,DL1
RET
DL10MS:MOV R1,#1 ;10MS延时程序
CONT:LCALL DL1MS
DJNZ R1,CONT
RET
DL500MS:MOV R5,#1 ;0.5S延时程序
CONT1:LCALL DL10MS
DJNZ R5,CONT1
RET
;-----字形码表---------------------------------
TABLE: DB 0C0H
DB 0F9H
DB 0A4H
DB 0B0H
DB 099H
DB 092H
DB 082H
DB 0F8H
DB 080H
DB 090H
